import React, { useState, useEffect, useRef } from 'react';
import { Play, FileText, Settings, Terminal, CheckCircle, XCircle, Clock, ChevronRight, Activity, Package, Shield, Layout, RefreshCw, GitPullRequest, List, FileJson, Copy } from 'lucide-react';

// --- Mock Data derived from PRD ---

const WORKFLOW_CATALOG = [
  {
    id: 'pr-review',
    title: 'PR Review Automation',
    category: 'Productivity',
    description: 'Fetch PR details, analyze diffs, and draft reviews via gh CLI.',
    inputs: ['PR Number', 'Repo Path', 'Auth Token'],
    icon: GitPullRequest,
    mode: 'Interactive',
    timeEstimate: '2m',
  },
  {
    id: 'changelog',
    title: 'Daily Changelog Generator',
    category: 'Productivity',
    description: 'Summarize recent commits and append to changelog.md.',
    inputs: ['Time Window', 'Author Filter'],
    icon: List,
    mode: 'Headless',
    timeEstimate: '30s',
  },
  {
    id: 'lint-sweep',
    title: 'Lint Sweep & Auto-Fix',
    category: 'Maintenance',
    description: 'Run linter, apply minimal fixes, and verify with tests.',
    inputs: ['Lint Command', 'Test Command'],
    icon: RefreshCw,
    mode: 'Headless',
    timeEstimate: '4m',
  },
  {
    id: 'pre-commit-gate',
    title: 'Pre-commit Risk Gate',
    category: 'Safety',
    description: 'Block risky commits via staged-diff review and severity thresholds.',
    inputs: ['Severity Threshold', 'Staged Diff'],
    icon: Shield,
    mode: 'Headless',
    timeEstimate: '10s',
  }
];

const MOCK_LOGS = {
  'pr-review': [
    "> cline task new -y 'Review PR #42'",
    "Initializing Cline environment...",
    "Authentication check: PASS",
    "Fetching PR #42 details via gh cli...",
    "Analyzing diff (24 files changed)...",
    "Identified 3 potential security concerns in src/auth.ts",
    "Drafting review comments...",
    "Review submitted to GitHub."
  ],
  'changelog': [
    "> git log --since='yesterday' --oneline",
    "Found 12 commits.",
    "Categorizing commits by type (feat, fix, chore)...",
    "Generating summary description...",
    "Appending to CHANGELOG.md...",
    "Success: Changelog updated."
  ],
  'lint-sweep': [
    "> npm run lint",
    "Found 42 lint errors.",
    "Applying auto-fixes...",
    "Re-running linter...",
    "Remaining errors: 5. Attempting manual fix via LLM...",
    "Running tests...",
    "Tests passed. created fix-lint-branch."
  ],
  'pre-commit-gate': [
    "> git diff --cached",
    "Analyzing staged changes...",
    "Checking against policy 'strict-security'...",
    "Verdict: ALLOW",
    "No high severity issues found."
  ]
};

const MOCK_ARTIFACTS = {
  'pr-review': {
    type: 'markdown',
    title: 'PR Analysis Report',
    content: `## PR #42 Review Summary
**Status:** Request Changes
**Severity:** High

### Key Findings
1. ðŸ”´ **Security:** Hardcoded credential pattern detected in \`auth.ts\`.
2. ðŸŸ¡ **Performance:** O(n^2) loop in \`dashboard.tsx\`.
3. ðŸŸ¢ **Style:** Good adherence to project patterns.

### Action Plan
- Remove API key from line 45.
- Optimize user filtering logic.`
  },
  'changelog': {
    type: 'markdown',
    title: 'CHANGELOG.md (Snippet)',
    content: `## [Unreleased] - 2024-05-20

### Features
- Added new dashboard visualization widgets.
- implemented OAuth2 login flow.

### Fixes
- Resolved race condition in user session handling.
- Fixed layout shift on mobile devices.`
  },
  'pre-commit-gate': {
    type: 'json',
    title: 'Gate Verdict',
    content: JSON.stringify({
      decision: "ALLOW",
      timestamp: "2024-05-20T10:30:00Z",
      policy: "default-strict",
      findings: [],
      metadata: {
        checked_files: 5,
        model: "gemini-1.5-pro"
      }
    }, null, 2)
  }
};

// --- Components ---

const Card = ({ children, className = "" }) => (
  <div className={`bg-white rounded-xl border border-slate-200 shadow-sm ${className}`}>
    {children}
  </div>
);

const Badge = ({ type, text }) => {
  const styles = {
    interactive: "bg-blue-100 text-blue-700",
    headless: "bg-purple-100 text-purple-700",
    success: "bg-green-100 text-green-700",
    running: "bg-amber-100 text-amber-700",
    default: "bg-slate-100 text-slate-700"
  };
  return (
    <span className={`text-xs font-medium px-2 py-0.5 rounded-full ${styles[type] || styles.default}`}>
      {text}
    </span>
  );
};

const TerminalView = ({ logs, isRunning }) => {
  const scrollRef = useRef(null);

  useEffect(() => {
    if (scrollRef.current) {
      scrollRef.current.scrollTop = scrollRef.current.scrollHeight;
    }
  }, [logs]);

  return (
    <div className="bg-slate-900 rounded-lg p-4 font-mono text-sm h-64 overflow-y-auto flex flex-col text-slate-300 shadow-inner" ref={scrollRef}>
      <div className="flex items-center gap-2 border-b border-slate-700 pb-2 mb-2 text-xs text-slate-500 uppercase tracking-wider">
        <Terminal size={12} /> Cline Console Output
      </div>
      {logs.map((log, i) => (
        <div key={i} className="mb-1 break-all">
          <span className="text-slate-500 mr-2">[{new Date().toLocaleTimeString()}]</span>
          <span className={log.startsWith(">") ? "text-yellow-400 font-bold" : "text-slate-300"}>
            {log}
          </span>
        </div>
      ))}
      {isRunning && (
        <div className="animate-pulse text-blue-400 mt-2">
          â–Š Processing step...
        </div>
      )}
    </div>
  );
};

const ArtifactViewer = ({ artifact }) => {
  if (!artifact) return null;

  return (
    <Card className="mt-4 overflow-hidden">
      <div className="bg-slate-50 border-b border-slate-200 px-4 py-2 flex items-center justify-between">
        <div className="flex items-center gap-2 font-medium text-slate-700">
          {artifact.type === 'json' ? <FileJson size={16} /> : <FileText size={16} />}
          {artifact.title}
        </div>
        <button
          className="text-slate-400 hover:text-slate-600 transition-colors"
          onClick={() => navigator.clipboard.writeText(artifact.content)}
          title="Copy to clipboard"
        >
          <Copy size={16} />
        </button>
      </div>
      <div className="p-4 bg-white overflow-x-auto">
        <pre className={`text-sm font-mono ${artifact.type === 'json' ? 'text-purple-700' : 'text-slate-700'}`}>
          {artifact.content}
        </pre>
      </div>
    </Card>
  );
};

export default function App() {
  const [activeTab, setActiveTab] = useState('catalog');
  const [selectedWorkflow, setSelectedWorkflow] = useState(null);
  const [runState, setRunState] = useState('idle'); // idle, running, complete
  const [logs, setLogs] = useState([]);
  const [result, setResult] = useState(null);
  const [activeRuns, setActiveRuns] = useState([]); // History of runs

  const handleRun = (workflow) => {
    setRunState('running');
    setLogs([]);
    setResult(null);
    setActiveTab('run');

    const workflowLogs = MOCK_LOGS[workflow.id] || ["Starting workflow..."];
    let step = 0;

    const interval = setInterval(() => {
      if (step < workflowLogs.length) {
        setLogs(prev => [...prev, workflowLogs[step]]);
        step++;
      } else {
        clearInterval(interval);
        setRunState('complete');
        const artifact = MOCK_ARTIFACTS[workflow.id];
        setResult(artifact);

        // Add to history
        const newRun = {
          id: Date.now(),
          workflowId: workflow.id,
          title: workflow.title,
          status: 'Success',
          timestamp: new Date().toLocaleTimeString(),
          artifact: artifact
        };
        setActiveRuns(prev => [newRun, ...prev]);
      }
    }, 800);
  };

  const SidebarItem = ({ id, icon: Icon, label, count }) => (
    <button
      onClick={() => setActiveTab(id)}
      className={`w-full flex items-center justify-between px-3 py-2 rounded-lg text-sm transition-colors ${
        activeTab === id
          ? "bg-blue-50 text-blue-700 font-medium"
          : "text-slate-600 hover:bg-slate-100"
      }`}
    >
      <div className="flex items-center gap-3">
        <Icon size={18} />
        {label}
      </div>
      {count !== undefined && (
        <span className="bg-slate-200 text-slate-600 text-xs px-2 py-0.5 rounded-full">
          {count}
        </span>
      )}
    </button>
  );

  return (
    <div className="min-h-screen bg-slate-50 flex font-sans text-slate-900">

      {/* Sidebar */}
      <aside className="w-64 bg-white border-r border-slate-200 flex flex-col fixed h-full z-10">
        <div className="p-6 border-b border-slate-100">
          <div className="flex items-center gap-2 text-blue-600 font-bold text-xl">
            <Layout className="fill-blue-600" size={24} />
            Cline Pack
          </div>
          <p className="text-xs text-slate-500 mt-1">Workflow Automation Suite</p>
        </div>

        <nav className="flex-1 p-4 space-y-1">
          <div className="text-xs font-semibold text-slate-400 uppercase tracking-wider mb-2 px-3">Platform</div>
          <SidebarItem id="catalog" icon={Package} label="Workflow Catalog" />
          <SidebarItem id="runs" icon={Activity} label="Run History" count={activeRuns.length} />

          <div className="text-xs font-semibold text-slate-400 uppercase tracking-wider mb-2 mt-6 px-3">Configuration</div>
          <SidebarItem id="settings" icon={Settings} label="Settings" />
          <SidebarItem id="gate-policy" icon={Shield} label="Gating Policy" />
        </nav>

        <div className="p-4 border-t border-slate-100">
          <div className="bg-slate-900 text-slate-300 p-3 rounded-lg text-xs">
            <div className="flex items-center gap-2 mb-1 text-white font-medium">
              <div className="w-2 h-2 rounded-full bg-green-400 animate-pulse"></div>
              System Online
            </div>
            <p>v2.1.0 â€¢ Connected</p>
          </div>
        </div>
      </aside>

      {/* Main Content */}
      <main className="flex-1 ml-64 p-8 max-w-7xl mx-auto w-full">

        {/* Header Area */}
        <header className="flex justify-between items-center mb-8">
          <div>
            <h1 className="text-2xl font-bold text-slate-900">
              {activeTab === 'catalog' && "Workflow Catalog"}
              {activeTab === 'run' && "Active Execution"}
              {activeTab === 'runs' && "Run History"}
              {activeTab === 'settings' && "System Settings"}
              {activeTab === 'gate-policy' && "Gating Policies"}
            </h1>
            <p className="text-slate-500 mt-1">
              {activeTab === 'catalog' && "Browse and launch standard engineering automations."}
              {activeTab === 'run' && "Monitor real-time workflow progress."}
              {activeTab === 'runs' && "Audit logs and previous execution artifacts."}
            </p>
          </div>
          <div className="flex gap-3">
             <button className="flex items-center gap-2 px-4 py-2 bg-white border border-slate-200 rounded-lg text-sm font-medium text-slate-700 hover:bg-slate-50 transition-colors shadow-sm">
                <RefreshCw size={16} /> Sync Pack
             </button>
          </div>
        </header>

        {/* Content Views */}

        {/* CATALOG VIEW */}
        {activeTab === 'catalog' && (
          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            {WORKFLOW_CATALOG.map((workflow) => (
              <Card key={workflow.id} className="hover:shadow-md transition-shadow cursor-pointer group flex flex-col h-full">
                <div className="p-6 flex flex-col flex-1">
                  <div className="flex justify-between items-start mb-4">
                    <div className="p-3 bg-blue-50 text-blue-600 rounded-lg group-hover:bg-blue-600 group-hover:text-white transition-colors">
                      <workflow.icon size={24} />
                    </div>
                    <Badge type={workflow.mode.toLowerCase()} text={workflow.mode} />
                  </div>

                  <h3 className="text-lg font-bold text-slate-900 mb-2">{workflow.title}</h3>
                  <p className="text-slate-500 text-sm mb-4 flex-1">{workflow.description}</p>

                  <div className="space-y-3">
                    <div className="flex flex-wrap gap-2">
                      {workflow.inputs.map(input => (
                        <span key={input} className="text-xs bg-slate-100 text-slate-600 px-2 py-1 rounded">
                          {input}
                        </span>
                      ))}
                    </div>

                    <div className="flex items-center gap-2 text-xs text-slate-400 pt-2 border-t border-slate-100">
                      <Clock size={12} />
                      Est. time: {workflow.timeEstimate}
                    </div>
                  </div>
                </div>

                <div className="p-4 bg-slate-50 border-t border-slate-200 rounded-b-xl">
                  <button
                    onClick={() => {
                      setSelectedWorkflow(workflow);
                      handleRun(workflow);
                    }}
                    className="w-full py-2 bg-white border border-slate-300 text-slate-700 font-medium rounded-lg hover:bg-blue-600 hover:text-white hover:border-blue-600 transition-all shadow-sm flex items-center justify-center gap-2"
                  >
                    <Play size={16} /> Run Workflow
                  </button>
                </div>
              </Card>
            ))}
          </div>
        )}

        {/* RUN / SIMULATION VIEW */}
        {activeTab === 'run' && (
          <div className="max-w-4xl mx-auto space-y-6">
            {!selectedWorkflow ? (
              <div className="text-center py-20 text-slate-400">
                <Package size={48} className="mx-auto mb-4 opacity-50" />
                <p>Select a workflow from the catalog to start a run.</p>
                <button onClick={() => setActiveTab('catalog')} className="mt-4 text-blue-600 font-medium hover:underline">
                  Go to Catalog
                </button>
              </div>
            ) : (
              <>
                <div className="flex items-center justify-between">
                  <div className="flex items-center gap-4">
                    <div className="p-2 bg-white border border-slate-200 rounded-lg shadow-sm">
                      <selectedWorkflow.icon size={24} className="text-blue-600" />
                    </div>
                    <div>
                      <h2 className="text-lg font-bold text-slate-900">{selectedWorkflow.title}</h2>
                      <div className="flex items-center gap-2 text-sm text-slate-500">
                        <span>Run ID: #8293-A</span>
                        <span>â€¢</span>
                        <span className="flex items-center gap-1">
                          {runState === 'running' ? (
                            <span className="text-amber-600 flex items-center gap-1"><Activity size={12} className="animate-spin" /> Running</span>
                          ) : (
                            <span className="text-green-600 flex items-center gap-1"><CheckCircle size={12} /> Complete</span>
                          )}
                        </span>
                      </div>
                    </div>
                  </div>

                  {runState === 'complete' && (
                    <button
                      onClick={() => {
                        setRunState('idle');
                        setSelectedWorkflow(null);
                        setActiveTab('catalog');
                      }}
                      className="px-4 py-2 text-sm text-slate-600 hover:bg-slate-100 rounded-lg"
                    >
                      Close Session
                    </button>
                  )}
                </div>

                <TerminalView logs={logs} isRunning={runState === 'running'} />

                {runState === 'complete' && result && (
                   <div className="animate-in fade-in slide-in-from-bottom-4 duration-500">
                     <div className="flex items-center gap-2 text-sm font-bold text-slate-900 mb-2">
                        <FileText size={16} className="text-blue-600" />
                        Generated Artifacts
                     </div>
                     <ArtifactViewer artifact={result} />
                   </div>
                )}
              </>
            )}
          </div>
        )}

        {/* RUN HISTORY VIEW */}
        {activeTab === 'runs' && (
          <div className="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden">
            <div className="overflow-x-auto">
              <table className="w-full text-sm text-left">
                <thead className="text-xs text-slate-500 uppercase bg-slate-50 border-b border-slate-200">
                  <tr>
                    <th className="px-6 py-3 font-semibold">Workflow</th>
                    <th className="px-6 py-3 font-semibold">Status</th>
                    <th className="px-6 py-3 font-semibold">Time</th>
                    <th className="px-6 py-3 font-semibold">Artifact</th>
                    <th className="px-6 py-3 font-semibold text-right">Actions</th>
                  </tr>
                </thead>
                <tbody>
                  {activeRuns.length === 0 ? (
                    <tr>
                      <td colSpan={5} className="px-6 py-12 text-center text-slate-400">
                        No runs yet. Start a workflow from the catalog.
                      </td>
                    </tr>
                  ) : (
                    activeRuns.map((run) => (
                      <tr key={run.id} className="border-b border-slate-100 last:border-0 hover:bg-slate-50">
                        <td className="px-6 py-4 font-medium text-slate-900">{run.title}</td>
                        <td className="px-6 py-4">
                          <span className="inline-flex items-center gap-1.5 px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                            <CheckCircle size={10} /> {run.status}
                          </span>
                        </td>
                        <td className="px-6 py-4 text-slate-500">{run.timestamp}</td>
                        <td className="px-6 py-4">
                           <button className="flex items-center gap-1 text-blue-600 hover:underline">
                              <FileText size={14} /> {run.artifact?.title || "View Report"}
                           </button>
                        </td>
                        <td className="px-6 py-4 text-right">
                          <button className="text-slate-400 hover:text-slate-600">
                            <ChevronRight size={16} />
                          </button>
                        </td>
                      </tr>
                    ))
                  )}
                </tbody>
              </table>
            </div>
          </div>
        )}

        {/* SETTINGS VIEW (Mock) */}
        {activeTab === 'settings' && (
          <div className="max-w-2xl space-y-6">
            <Card className="p-6">
              <h3 className="text-lg font-bold text-slate-900 mb-4">Hooks Enablement Integration</h3>
              <p className="text-sm text-slate-500 mb-6">
                Ensure optional hooks enforcement is enabled for consistent automation across your local repository.
              </p>

              <div className="space-y-4">
                <div className="flex items-center justify-between p-3 bg-slate-50 rounded-lg border border-slate-200">
                   <div>
                     <div className="font-medium text-slate-900">Pre-commit Hook</div>
                     <div className="text-xs text-slate-500">Blocks commits based on risk gate verdict</div>
                   </div>
                   <div className="w-10 h-6 bg-blue-600 rounded-full relative cursor-pointer">
                      <div className="absolute right-1 top-1 w-4 h-4 bg-white rounded-full"></div>
                   </div>
                </div>

                <div className="flex items-center justify-between p-3 bg-slate-50 rounded-lg border border-slate-200">
                   <div>
                     <div className="font-medium text-slate-900">Pre-push Hook</div>
                     <div className="text-xs text-slate-500">Runs full test suite before push</div>
                   </div>
                   <div className="w-10 h-6 bg-slate-300 rounded-full relative cursor-pointer">
                      <div className="absolute left-1 top-1 w-4 h-4 bg-white rounded-full"></div>
                   </div>
                </div>
              </div>
            </Card>

             <Card className="p-6">
              <h3 className="text-lg font-bold text-slate-900 mb-4">System Path Configuration</h3>
              <div className="grid gap-4">
                <div>
                   <label className="block text-sm font-medium text-slate-700 mb-1">Local Repo Path</label>
                   <input type="text" className="w-full border border-slate-300 rounded-md px-3 py-2 text-sm" value="/Users/engineer/dev/cline-pack" readOnly />
                </div>
                <div>
                   <label className="block text-sm font-medium text-slate-700 mb-1">Global Config Path</label>
                   <input type="text" className="w-full border border-slate-300 rounded-md px-3 py-2 text-sm" value="~/.clinerules/workflows" readOnly />
                </div>
              </div>
             </Card>
          </div>
        )}

      </main>
    </div>
  );
}